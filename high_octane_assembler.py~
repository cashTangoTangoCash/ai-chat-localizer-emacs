#!/usr/bin/env python3

import subprocess
from pathlib import Path

def run_cmark(input_text, output_path):
    """Pipes text into cmark-gfm and saves to output_path."""
    try:
        process = subprocess.Popen(
            ['cmark-gfm', '--unsafe'], 
            stdin=subprocess.PIPE, 
            stdout=subprocess.PIPE, 
            stderr=subprocess.PIPE, 
            text=True
        )
        stdout, stderr = process.communicate(input=input_text)
        with open(output_path, "w", encoding="utf-8") as f:
            f.write(stdout)
    except FileNotFoundError:
        print("Error: cmark-gfm not found.")

def assemble_everything():
    cwd = Path.cwd()
    chat_dir = cwd / "chat"
    captures_dir = chat_dir / "captures"
    
    chat_dir.mkdir(parents=True, exist_ok=True)
    files = sorted(captures_dir.glob("*_captures.md"))
    
    if not files:
        print("No captures found.")
        return

    # --- PART 1: Full Transcript ---
    full_md_path = chat_dir / "full_transcript.md"
    full_html_path = chat_dir / "full_transcript.html"
    full_content = [f"# Full Transcript: {cwd.name}\n\n"]

    for i, f_path in enumerate(files):
        # Calculate labels
        turn_num = (i // 2) + 1
        label = "PROMPT" if i % 2 == 0 else "RESPONSE"
        
        with open(f_path, "r", encoding="utf-8") as f_in:
            body = f_in.read().strip()
            
            # Add the header you missed!
            full_content.append(f"# {label} {turn_num}")
            full_content.append(body)
            # Naked Lisp for easy Emacs evaluation
            full_content.append(f"\nEdit: (find-file \"{f_path}\")\n\n---\n")

    full_md_text = "\n".join(full_content)
    with open(full_md_path, "w", encoding="utf-8") as f_out:
        f_out.write(full_md_text)
    
    run_cmark(full_md_text, full_html_path)

    # --- PART 2: Linked Individual Pages ---
    for i, f_path in enumerate(files):
        turn_num = (i // 2) + 1
        label = "PROMPT" if i % 2 == 0 else "RESPONSE"
        title = f"{label} {turn_num}"

        with open(f_path, "r", encoding="utf-8") as f_in:
            raw_body = f_in.read().strip()

        # Navigation Links
        prev_link = f"[← Previous]({files[i-1].stem}.html)" if i > 0 else "← Start"
        next_link = f"[Next →]({files[i+1].stem}.html)" if i < len(files) - 1 else "End →"
        nav_bar = f"\n\n**{prev_link} | [Full Index](../full_transcript.html) | {next_link}**\n\n"

        # Combine everything for the individual page
        # Note: We put the Turn Label at the very top
        linked_md = f"# {title}\n{nav_bar}---\n\n{raw_body}\n\n---\n{nav_bar}Edit: (find-file \"{f_path}\")"
        
        output_html = captures_dir / f"{f_path.stem}.html"
        run_cmark(linked_md, output_html)

    print(f"✅ Re-assembled with {len(files)} numbered segments.")

if __name__ == "__main__":
    assemble_everything()
